generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum ProjectType {
  VERKOOP
  AANKOOP
  TAXATIE
}

enum ProjectStatus {
  LEAD
  GESPREK_GEPLAND
  OFFERTE_VERSTUURD
  OTD_VERSTUURD
  OTD_ONDERTEKEND
  IN_VOORBEREIDING
  LIVE_FUNDA
  ONDER_BOD
  KOOPAKTE
  GEPASSEERD
  AFGEROND
  GEANNULEERD
  IN_UITVOERING
  RAPPORT_CONCEPT
}

enum Verkoopstart {
  DIRECT
  UITGESTELD
  SLAPEND
}

enum Verkoopmethode {
  INSCHRIJVING_MET_BIEDTERMIJN
  GESLOTEN_INSCHRIJVING_MET_BIEDTERMIJN
  OPEN_VEILING_MET_BIEDTERMIJN
  BIEDEN_ZONDER_BIEDTERMIJN
}

// ─── Models ───────────────────────────────────────────────────────────────────

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  password      String
  role          String   @default("makelaar") // manager, makelaar, binnendienst
  active        Boolean  @default(true)
  assignedTasks Task[]   @relation("assignee")
  createdTasks  Task[]   @relation("creator")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("users")
}

model Project {
  id              String           @id @default(cuid())
  name            String
  description     String?          @db.Text

  // Type en status
  type            ProjectType      @default(VERKOOP)
  projectStatus   ProjectStatus?   // tijdelijk nullable voor migratie; wordt na data-migratie gevuld
  status          String           @default("lead") // legacy — blijft staan totdat migratie compleet is

  // Verkoopstart (alleen relevant bij type=VERKOOP)
  verkoopstart    Verkoopstart?
  startdatum      DateTime?
  startReden      String?

  // Legacy velden (bewaren voor backward-compat)
  address         String?
  notionPageId    String?          @unique
  mauticContactId Int?             // Fallback voor backward-compat (legacy)
  realworksId     String?          // Koppeling met woning op WordPress via Realworks ID
  contactName     String?          // Fallback contactnaam (legacy)
  contactPhone    String?          // Fallback telefoonnummer (legacy)
  contactEmail    String?          // Fallback emailadres (legacy)

  // Woning velden
  woningAdres       String?
  woningPostcode    String?
  woningPlaats      String?
  kadGemeente       String?
  kadSectie         String?
  kadNummer         String?
  woningOppervlakte String?

  // Commercieel
  vraagprijs          Int?
  courtagePercentage  String?
  verkoopmethode      Verkoopmethode?
  bijzondereAfspraken String?          @db.Text

  // Kosten
  kostenPubliciteit   Int?
  kostenEnergielabel  Int?
  kostenJuridisch     Int?
  kostenBouwkundig    Int?
  kostenIntrekking    Int?
  kostenBedenktijd    Int?

  // Relaties
  contacts        ProjectContact[]
  tasks           Task[]
  calls           Call[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([status])
  @@index([projectStatus])
  @@index([type])
  @@index([notionPageId])
  @@index([mauticContactId])
  @@index([realworksId])
  @@map("projects")
}

model ProjectContact {
  id              String   @id @default(cuid())
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId       String
  mauticContactId Int
  role            String   @default("opdrachtgever") // opdrachtgever, partner, gemachtigde, overig
  label           String?
  addedAt         DateTime @default(now())
  addedBy         String?

  @@unique([projectId, mauticContactId])
  @@index([projectId])
  @@index([mauticContactId])
  @@map("project_contacts")
}

model Call {
  id                String   @id @default(cuid())
  callId            String   @unique
  timestamp         DateTime
  status            String   // ringing, in-progress, ended
  reason            String?  // completed, no-answer, busy, cancelled
  direction         String   // inbound, outbound
  callerNumber      String
  callerName        String?
  destinationNumber String
  destinationUser   String?
  mauticContactId   Int?
  contactName       String?
  points            Int      @default(0)
  project           Project? @relation(fields: [projectId], references: [id])
  projectId         String?
  notes             CallNote[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([timestamp])
  @@index([callerNumber])
  @@index([mauticContactId])
  @@index([projectId])
  @@map("calls")
}

model CallNote {
  id        String   @id @default(cuid())
  call      Call     @relation(fields: [callId], references: [id])
  callId    String
  note      String   @db.Text
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([callId])
  @@map("call_notes")
}

model Task {
  id               String      @id @default(cuid())
  title            String
  description      String?     @db.Text
  status           String      @default("open") // open, bezig, afgerond
  priority         String      @default("normaal") // laag, normaal, hoog, urgent
  dueDate          DateTime?
  category         String?     // binnendienst, verkoop, aankoop, taxatie, administratie
  assignee         User        @relation("assignee", fields: [assigneeId], references: [id])
  assigneeId       String
  creator          User        @relation("creator", fields: [creatorId], references: [id])
  creatorId        String
  project          Project?    @relation(fields: [projectId], references: [id])
  projectId        String?
  notionPageId     String?
  completedAt      DateTime?
  // Tijdregistratie
  timerStartedAt   DateTime?   // null = timer gestopt, gevuld = timer loopt
  totalTimeSpent   Int         @default(0) // opgetelde seconden van afgesloten sessies
  timeEntries      TimeEntry[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@index([projectId])
  @@map("tasks")
}

model TimeEntry {
  id        String    @id @default(cuid())
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    String
  startedAt DateTime
  stoppedAt DateTime?  // null = sessie nog actief
  duration  Int       @default(0) // seconden, ingevuld bij stoppen
  createdAt DateTime  @default(now())

  @@index([taskId])
  @@map("time_entries")
}

model MauticEvent {
  id              String   @id @default(cuid())
  mauticContactId Int
  eventType       String   // "email.click", "email.open", "page.hit", "form.submit"
  emailName       String?
  emailId         Int?
  clickedUrl      String?  @db.Text
  ipAddress       String?
  occurredAt      DateTime
  rawPayload      Json?
  createdAt       DateTime @default(now())

  @@index([mauticContactId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("mautic_events")
}

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique  // bijv. "defaults_VERKOOP"
  value     Json               // flexibele JSON waarde
  updatedAt DateTime @updatedAt

  @@map("app_settings")
}
